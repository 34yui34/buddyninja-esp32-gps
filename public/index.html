<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Location Tracker Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .server-info {
            background: #f0f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            font-size: 0.9em;
            text-align: left;
        }

        .server-info code {
            background: #e0e7ff;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            flex: 1;
            text-align: right;
            font-size: 14px;
            color: #666;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-active {
            background: #10b981;
        }

        .status-inactive {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .current-data {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .current-data h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .data-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-card-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .data-card-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .history {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .history h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
        }

        .history-table thead {
            background: #667eea;
            color: white;
        }

        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .history-table tbody tr:hover {
            background: #f3f4f6;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }

            .status {
                text-align: center;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìç ESP32 Location Tracker</h1>
            <p>Real-time GPS tracking and monitoring dashboard</p>
            <div class="server-info">
                <strong>üîó ESP32 Configuration:</strong><br>
                Set your server URL to: <code id="serverUrl">Loading...</code>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh Data</button>
            <button class="btn btn-success" onclick="downloadCSV()" id="downloadBtn">üì• Download CSV</button>
            <button class="btn btn-danger" onclick="clearData()" id="clearBtn">üóëÔ∏è Clear History</button>
            <div class="status">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Connecting...</span>
            </div>
        </div>

        <div class="current-data">
            <h2>Current Location</h2>
            <div id="currentDevice">Waiting for data...</div>
            <div class="data-grid" id="dataGrid">
                <div class="data-card">
                    <div class="data-card-label">Longitude</div>
                    <div class="data-card-value" id="currentLon">--</div>
                </div>
                <div class="data-card">
                    <div class="data-card-label">Latitude</div>
                    <div class="data-card-value" id="currentLat">--</div>
                </div>
                <div class="data-card">
                    <div class="data-card-label">Battery</div>
                    <div class="data-card-value" id="currentBat">--%</div>
                </div>
                <div class="data-card">
                    <div class="data-card-label">Last Update</div>
                    <div class="data-card-value" id="currentTime" style="font-size: 1.2em;">--:--:--</div>
                </div>
            </div>
        </div>

        <div class="history">
            <h2>Location History (<span id="dataCount">0</span> entries)</h2>
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Device ID</th>
                            <th>Longitude</th>
                            <th>Latitude</th>
                            <th>Battery (%)</th>
                            <th>Date</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr>
                            <td colspan="6" class="no-data">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Determine API base URL
        const API_BASE = window.location.origin;
        
        let locationHistory = [];
        let autoRefreshInterval;

        // Initialize on page load
        window.addEventListener('load', () => {
            document.getElementById('serverUrl').textContent = `${API_BASE}/api/data`;
            checkServerStatus();
            refreshData();
            startAutoRefresh();
        });

        // Check server status
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    updateStatus(true, `Server connected - ${data.dataCount} entries`);
                }
            } catch (error) {
                updateStatus(false, 'Server offline');
                console.error('Server check failed:', error);
            }
        }

        // Update status indicator
        function updateStatus(isActive, message) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (isActive) {
                indicator.className = 'status-indicator status-active';
            } else {
                indicator.className = 'status-indicator status-inactive';
            }
            
            statusText.textContent = message;
        }

        // Fetch data from server
        async function refreshData() {
            try {
                const response = await fetch(`${API_BASE}/api/data`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    locationHistory = result.data || [];
                    updateDisplay();
                    updateHistory();
                    updateStatus(true, `Last refresh: ${new Date().toLocaleTimeString()}`);
                }
            } catch (error) {
                console.error('Failed to fetch data:', error);
                updateStatus(false, 'Failed to fetch data');
            }
        }

        // Update current display
        function updateDisplay() {
            if (locationHistory.length === 0) {
                document.getElementById('currentDevice').textContent = 'Waiting for data...';
                document.getElementById('currentLon').textContent = '--';
                document.getElementById('currentLat').textContent = '--';
                document.getElementById('currentBat').textContent = '--%';
                document.getElementById('currentTime').textContent = '--:--:--';
                return;
            }

            const latest = locationHistory[locationHistory.length - 1];
            document.getElementById('currentDevice').textContent = `Device: ${latest.id}`;
            document.getElementById('currentLon').textContent = latest.longitude + '¬∞';
            document.getElementById('currentLat').textContent = latest.latitude + '¬∞';
            document.getElementById('currentBat').textContent = latest.battery + '%';
            document.getElementById('currentTime').textContent = latest.time;
        }

        // Update history table
        function updateHistory() {
            const tbody = document.getElementById('historyBody');
            const countEl = document.getElementById('dataCount');
            
            countEl.textContent = locationHistory.length;
            
            if (locationHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No data received yet</td></tr>';
                document.getElementById('downloadBtn').disabled = true;
                document.getElementById('clearBtn').disabled = true;
                return;
            }

            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('clearBtn').disabled = false;

            tbody.innerHTML = locationHistory.map(data => `
                <tr>
                    <td>${data.id}</td>
                    <td>${data.longitude}¬∞</td>
                    <td>${data.latitude}¬∞</td>
                    <td>${data.battery}%</td>
                    <td>${data.date}</td>
                    <td>${data.time}</td>
                </tr>
            `).reverse().join('');
        }

        // Download CSV
        function downloadCSV() {
            if (locationHistory.length === 0) {
                alert('No data to download');
                return;
            }

            const headers = ['Device ID', 'Longitude', 'Latitude', 'Battery (%)', 'Date', 'Time'];
            const csvContent = [
                headers.join(','),
                ...locationHistory.map(data => 
                    `${data.id},${data.longitude},${data.latitude},${data.battery},${data.date},${data.time}`
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `esp32_locations_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Clear data
        async function clearData() {
            if (!confirm('Are you sure you want to clear all location history?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/data`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    locationHistory = [];
                    updateDisplay();
                    updateHistory();
                    updateStatus(true, 'Data cleared');
                }
            } catch (error) {
                console.error('Failed to clear data:', error);
                alert('Failed to clear data');
            }
        }

        // Auto-refresh every 30 seconds
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                refreshData();
            }, 30000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>